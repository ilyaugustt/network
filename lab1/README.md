# Лабораторная работа №3 "НА Postgres Cluster"

# Часть 1. Поднимаем Postgres
1. Создание и поднятие docker контейнеров:
![docker](images/img.png)
2. Определение master и slave ноды (master - pg-master, slave - pg-slave)
![Нода postgres0 postgres1](images/img_1.png)
3. Проверка, что зукипер запустился
![Zookiper](images/img_2.png)

## Часть 2. Проверяем репликацию
4. Подключение к нодам постгреса

![подключение 1](images/img_3.png)
![подключение 2](images/img_4.png)

6. В ноду лидера кластера (pg-master) добавляем таблицу и вставляем в неё данные
![создание таблицы](images/img_5.png)

7. Проверяем, что в pg-slave также создалась эта таблица с теми же данными
![image](images/img_6.png)

8. Неудачно пытаемся удалить строчку из таблицы подключения pg-slave
![image](images/img_7.png)

## Часть 3. Делаем высокую доступность
8. Перезапускаем docker контейнеры после добавления необходимых конфигурационных файлов и обновления docker-compose.yml для HAProxy
![image](images/img_8.png)
9. Проверяем перераспределение ролей (роли те же)
![image](images/img_9.png)
10. Проверяем зукипер
![image](images/img_10.png)
11. Создаём подключение к pg-entrypoint (haproxy)
![image](images/img_11.png)
12. Пытаемся заселектить данные из мастер-ноды
![image](images/img_12.png)

## Задание
13. Отключаю мастер-ноду командой `docker stop pg-master`
14. Наблюдаю за логами pg-slave и haproxy. В логах у pg-slave замечаю, patroni перераспределил роли, и теперь pg-slave является лидером.
![image](images/img_13.png)
![image](images/img_14.png)
15. В entrypoint-подключение добавляю новую строчку, которая дублируется и в pg-slave
![image](images/img_15.png)
![image](images/img_16.png)
Также можно заметить, что у pg-slave пропало read-only ограничение!

## Ответы на вопросы
1. Порты 8008 и 5432 вынесены в разные директивы, expose и ports. По сути, если записать 8008 в ports, то он тоже станет exposed. В чем разница?
Порты в директивах expose доступны только в пределах сети docker compose, а в директивах ports порты будут открыты на хост-машины, и будут доступны извне.
2. При обычном перезапуске композ-проекта, будет ли сбилден заново образ? А если предварительно отредактировать файлы postgresX.yml? А если содержимое самого Dockerfile? Почему?**
Compose образы не пересобираются, если не используется флаг --build, так как изменения в конфигурации применяются сразу, а изменения в Dockerfile требуют пересборки.




